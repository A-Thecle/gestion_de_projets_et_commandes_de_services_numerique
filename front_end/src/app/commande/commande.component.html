<div *ngIf="loading">Chargement des commandes...</div>

<div class="commandes-cards" *ngIf="!loading">
  <div class="commande-card" *ngFor="let cmd of paginatedCommandes">
    <div class="card-header">
      <span class="commande-id">{{ cmd.commandes_id }}</span>
      <span class="statut">{{ cmd.statut_commande }}</span>
    </div>
    
    <div class="card-body">
      <p><strong>Client:</strong> {{ cmd.client.nom }} {{ cmd.client.prenom }} ({{ cmd.client.email }})</p>
      <p><strong>Service:</strong> {{ cmd.service.nom_service }} - {{ cmd.service.prix_estime | currency:'EUR' }}</p>
      <p><strong>Description:</strong> 
        {{ cmd.description_besoins.length > 20 ? (cmd.description_besoins | slice:0:20) + '...' : cmd.description_besoins }}
        <button *ngIf="cmd.description_besoins.length > 20" class="btn-voir-plus" (click)="openDescriptionModal(cmd.description_besoins)">Voir plus</button>
      </p>
      <p *ngIf="cmd.fichier_joint">
        <strong>Fichier joint:</strong>
        <a [href]="encodeFileUrl(cmd.fichier_joint)" target="_blank">Ouvrir le fichier joint</a>
      </p>
      <p><strong>Date Commande:</strong> {{ cmd.date_commande | date:'dd/MM/yyyy HH:mm' }}</p>
      <p><strong>Date Livraison:</strong> {{ cmd.date_livraison ? (cmd.date_livraison | date:'dd/MM/yyyy') : '-' }}</p>
      <p><strong>Montant estimé:</strong> {{ cmd.montant_final | number:'1.2-2' }}</p>
    </div>
    
    <div class="card-footer">
      <button class="btn-valider" (click)="confirmAction(cmd.commandes_id, 'valider')">Valider</button>
      <button class="btn-refuser" (click)="confirmAction(cmd.commandes_id, 'refuser')">Refuser</button>
    </div>
  </div>

  <!-- Modal pour la description complète -->
  <div class="modal-backdrop" *ngIf="showDescriptionModal">
    <div class="modal-content">
      <button class="close-btn" (click)="closeDescriptionModal()">&times;</button>
      <h2>Description complète</h2>
      <p class="description">{{ selectedDescription }}</p>
      <div class="modal-actions">
        <button class="btn-close" (click)="closeDescriptionModal()">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation -->
  <div class="confirmation-modal" *ngIf="showConfirmModal">
    <div class="modal-content">
      <h3>
        Voulez-vous vraiment
        {{ currentAction === 'valider' ? 'valider' : 'refuser' }}
        cette commande ?
      </h3>
      <div class="modal-actions">
        <button (click)="executeAction()">Oui</button>
        <button (click)="showConfirmModal = false" style="color: red;">Non</button>
      </div>
    </div>
  </div>

  <!-- Modal de succès -->
  <div class="confirmation-modal" *ngIf="showSuccessModal">
    <div class="modal-content">
      <h3>{{ successMessage }}</h3>
      <button (click)="closeSuccessModal()">OK</button>
    </div>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <button (click)="prevPage()" [disabled]="currentPage === 1">Précédent</button>
    <span>Page {{currentPage}} / {{totalPages}}</span>
    <button (click)="nextPage()" [disabled]="currentPage === totalPages">Suivant</button>
  </div>
</div>